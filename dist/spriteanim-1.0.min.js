function SpriteAnim(t){this.canvas=document.getElementById(t),this.init=function(){this.context=this.webgl_support(this.canvas)?this.create3DContext(this.canvas):this.canvas.getContext("2d")},this.init(),this.start=function(t){return this.webgl_support(this.canvas)?void this.webgl(t):(this.spriteObj=t,this.canvas.width=this.spriteObj.frameWidth,this.canvas.height=this.spriteObj.frameHeight,this.width=this.spriteObj.image.width,this.height=this.spriteObj.image.height,this.image=this.spriteObj.image,this.fps=this.spriteObj.fps,this.timestamp_init=Date.now(),this.interval=1e3/this.fps,this.timestamp_now,this.delta,this.horizontalframeIndex=0,this.verticalFrameIndex=0,this.horizontalFrames=this.width/t.frameWidth||1,this.verticalFrames=this.height/t.frameHeight||1,this.loopSprite=this.spriteObj.loop||!1,this.playSprite=!0,t.className&&(this.canvas.className=this.canvas.className?this.canvas.className+" "+t.className:t.className),void this.onStart())},this.stop=function(){this.playSprite=!1,this.context.clearRect(0,0,this.width,this.height)},this.onStart=function(){this.ticker(),this.spriteObj.onStart&&this.spriteObj.onStart()},this.onComplete=function(){this.spriteObj.onComplete&&this.spriteObj.onComplete()},this.update=function(){this.horizontalframeIndex<this.horizontalFrames?(this.horizontalframeIndex+=1,this.draw()):this.verticalFrameIndex<this.verticalFrames?(this.verticalFrameIndex+=1,this.horizontalframeIndex=1,this.draw()):(this.loopSprite?(this.verticalFrameIndex=1,this.horizontalframeIndex=1,this.draw()):this.stop(),this.onComplete())},this.draw=function(){this.context.clearRect(0,0,this.width,this.height),this.context.drawImage(this.image,(this.horizontalframeIndex-1)*this.width/this.horizontalFrames,(this.verticalFrameIndex-1)*this.height/this.verticalFrames,this.width/this.horizontalFrames,this.height,0,0,this.width/this.horizontalFrames,this.height)},this.ticker=function(){this.playSprite&&(window.requestAnimationFrame(this.ticker.bind(this)),this.timestamp_now=Date.now(),this.delta=this.timestamp_now-this.timestamp_init,this.delta>this.interval&&(this.timestamp_init=this.timestamp_now-this.delta%this.interval,this.update()))}}SpriteAnim.prototype.webgl=function(t){function i(){this.spriteSheetCreateSprite(),e()}function e(){this.requestAnimationFrame(e,this.canvas);var t=.001*(new Date).getTime();o.context.viewport(0,0,this.canvas.width,this.canvas.height),o.context.clearColor(0,0,0,0),o.context.clear(o.context.COLOR_BUFFER_BIT|o.context.DEPTH_BUFFER_BIT),o.sysDraw(o,0),h=t}function s(){var t=0,i=0;"number"==typeof window.innerWidth?(t=window.innerWidth,i=window.innerHeight):window.document.documentElement&&(window.document.documentElement.clientWidth||window.document.documentElement.clientHeight)?(t=window.document.documentElement.clientWidth,i=window.document.documentElement.clientHeight):window.document.body&&(window.document.body.clientWidth||window.document.body.clientHeight)&&(t=window.document.body.clientWidth,i=window.document.body.clientHeight),r=t,a=i}function n(){s(),o.canvas.width=200,o.canvas.height=200,o.screenWidth_=200,o.screenHeight_=200}var o=this;this.onload=null,this.numOutstandingRequests_=0,this.spriteSheets_=[],this.textures_=[],this.currentTextureUnit_=0;var h,r,a;this.canvas,this.context&&(this.constantAttributeInfo_=[{size:1,offset:0},{size:1,offset:0},{size:1,offset:0},{size:2,offset:0},{size:2,offset:0},{size:1,offset:0},{size:1,offset:0},{size:4,offset:0}],this.initialize_=function(){if(!this.initialized_){for(var t=this.constantAttributeInfo_,i=0,e=0;e<t.length;++e)t[e].offset=i,i+=t[e].size;this.constantAttributeStride_=i,this.initialized_=!0}},this.constantAttributeStride_=0,this.ROTATION_INDEX=0,this.PER_SPRITE_FRAME_OFFSET_INDEX=1,this.SPRITE_SIZE_INDEX=2,this.CORNER_OFFSET_INDEX=3,this.SPRITE_TEXTURE_SIZE_INDEX=4,this.SPRITES_PER_ROW_INDEX=5,this.NUM_FRAMES_INDEX=6,this.TEXTURE_WEIGHTS_INDEX=7,this.initialize_(),this.options=t,this.sysLoadProgram_(this.options),this.frameOffset_=0,this.spriteBuffer_=this.context.createBuffer(),this.sysClearAllSprites(),this.offsets_=[[-.5,-.5],[-.5,.5],[.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],this.initialized_=!1,n(),h=.001*(new Date).getTime(),this.onload=i,this.atlas_=this,this.name_="boom",this.params_={url:"images/explosion.png",frames:59,spritesPerRow:8,width:256,height:256},this.textureUnit_=0,this.perSpriteFrameOffset_=0,this.spriteSheets_.push(this),this.startLoading())},SpriteAnim.prototype.webgl_support=function(){for(var t=["webgl","experimental-webgl"],i=null,e=0;e<t.length;++e){try{i=this.canvas.getContext(t[e])}catch(s){}if(i)break}return i?!0:void 0},SpriteAnim.prototype.create3DContext=function(){function t(){return!1}for(var i=["webgl","experimental-webgl"],e=null,s=0;s<i.length;++s){try{e=this.canvas.getContext(i[s])}catch(n){}if(e)break}return e&&(this.context=e,this.canvas.tdl||(this.canvas.tdl={}),e.tdl={},e.tdl.depthTexture=this.getExtensionWithKnownPrefixes("WEBGL_depth_texture"),this.canvas.onselectstart=t,this.canvas.onmousedown=t),e},SpriteAnim.prototype.getExtensionWithKnownPrefixes=function(t){this.browserPrefixes_=["","MOZ_","OP_","WEBKIT_"];for(var i=0;i<this.browserPrefixes_.length;++i){var e=this.browserPrefixes_[i]+t,s=this.context.getExtension(e);if(s)return s}},SpriteAnim.prototype.requestAnimationFrame=function(t,i){return this.requestAnimationFrameImpl_||(tdl.webgl.requestAnimationFrameImpl_=function(){for(var t=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],i=0;i<t.length;++i){var e=t[i];if(window[e])return function(t){return function(i,e){return window[t].call(window,i,e)}}(e)}return function(t){return window.setTimeout(t,1e3/70)}}()),this.requestAnimationFrameImpl_(t,i)},SpriteAnim.prototype.startLoading=function(){var t=this.spriteSheets_.length;this.numOutstandingRequests_=t,this.spriteSheetStartLoading()},SpriteAnim.prototype.spriteSheetLoaded_=function(t,i){var e=this.context.createTexture();this.context.bindTexture(this.context.TEXTURE_2D,e),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.context.RGBA,this.context.UNSIGNED_BYTE,i),t.spriteSheetInitialize(this.currentTextureUnit_,i.width,i.height),this.textures_[this.currentTextureUnit_]=e,++this.currentTextureUnit_,0==--this.numOutstandingRequests_&&this.onload&&this.onload()},SpriteAnim.prototype.spriteSheetStartLoading=function(){var t=this,i=new Image;this.image_=i,i.onload=function(){t.onload_()},i.src=this.params_.url},SpriteAnim.prototype.spriteSheetInitialize=function(t,i,e){this.textureUnit_=t,this.textureWidth_=i,this.textureHeight_=e},SpriteAnim.prototype.spriteSheetCreateSprite=function(){var t=this.screenWidth_,i=this.screenHeight_,e=Math.random()*t,s=Math.random()*i,n=2*Math.random()*Math.PI,o=Math.random()*(t/5)-t/10,h=Math.random()*(i/5)-i/10,r=this.perSpriteFrameOffset_++;this.perSpriteFrameOffset_>=this.params_.frames&&(this.perSpriteFrameOffset_=0);var a=this.params_.width,c=1*this.params_.width/this.textureWidth_,_=1*this.params_.height/this.textureHeight_,f=this.params_.spritesPerRow,u=this.params_.frames,p=[0,0,0,0];p[this.textureUnit_]=1,this.sysAddSprite(e,s,n,o,h,r,a,c,_,f,u,p)},SpriteAnim.prototype.onload_=function(){this.atlas_.spriteSheetLoaded_(this,this.image_,this.params_)},SpriteAnim.prototype.sysLoadShader=function(t,i){var e=this.context.createShader(i);this.context.shaderSource(e,t),this.context.compileShader(e);this.context.getShaderParameter(e,this.context.COMPILE_STATUS);return e},SpriteAnim.prototype.sysClearAllSprites=function(){this.sysResizeCapacity_(120,!1),this.frameOffset_=0,this.numVertices_=0,this.precisePositionView_=null},SpriteAnim.prototype.sysLoadProgram_=function(t){var i=t&&t.slow?"slowSpriteFragmentShader":"spriteFragmentShader",e=this.sysLoadShader(document.getElementById("spriteVertexShader").text,this.context.VERTEX_SHADER),s=this.sysLoadShader(document.getElementById(i).text,this.context.FRAGMENT_SHADER),n=this.context.createProgram();this.context.attachShader(n,e),this.context.attachShader(n,s),this.context.linkProgram(n);this.context.getProgramParameter(n,this.context.LINK_STATUS);this.context.deleteShader(e),this.context.deleteShader(s),this.program_=n,this.frameOffsetLoc_=this.context.getUniformLocation(n,"u_frameOffset"),this.screenDimsLoc_=this.context.getUniformLocation(n,"u_screenDims"),this.centerPositionLoc_=this.context.getAttribLocation(n,"centerPosition"),this.rotationLoc_=this.context.getAttribLocation(n,"rotation"),this.perSpriteFrameOffsetLoc_=this.context.getAttribLocation(n,"perSpriteFrameOffset"),this.spriteSizeLoc_=this.context.getAttribLocation(n,"spriteSize"),this.cornerOffsetLoc_=this.context.getAttribLocation(n,"cornerOffset"),this.spriteTextureSizeLoc_=this.context.getAttribLocation(n,"spriteTextureSize"),this.spritesPerRowLoc_=this.context.getAttribLocation(n,"spritesPerRow"),this.numFramesLoc_=this.context.getAttribLocation(n,"numFrames"),this.textureWeightsLoc_=this.context.getAttribLocation(n,"textureWeights"),this.texture0Loc_=this.context.getUniformLocation(n,"u_texture0"),this.texture1Loc_=this.context.getUniformLocation(n,"u_texture1"),this.texture2Loc_=this.context.getUniformLocation(n,"u_texture2"),this.texture3Loc_=this.context.getUniformLocation(n,"u_texture3")},SpriteAnim.prototype.sysResizeCapacity_=function(t,i){var e=null,s=null,n=null,o=null,h=null;if(i&&(e=this.positionData_,s=this.constantData_,n=this.startPositionData_,o=this.velocityData_,h=this.spriteSizeData_),this.capacity_=t,this.positionData_=new Float32Array(2*t),this.constantData_=new Float32Array(this.constantAttributeStride_*t),this.startPositionData_=new Array(2*t),this.velocityData_=new Array(2*t),this.spriteSizeData_=new Array(t),this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+this.constantData_.length),this.context.DYNAMIC_DRAW),i){this.positionData_.set(e),this.constantData_.set(s),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.positionData_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,this.constantData_);for(var r=0;r<n.length;++r)this.startPositionData_[r]=n[r];for(var r=0;r<o.length;++r)this.velocityData_[r]=o[r];for(var r=0;r<h.length;++r)this.spriteSizeData_[r]=h[r]}},SpriteAnim.prototype.sysAddSprite=function(t,i,e,s,n,o,h,r,a,c,_,f){for(var u=this.offsets_,p=0;p<u.length;++p)this.sysAddVertex_(t,i,e,s,n,o,h,u[p][0],u[p][1],r,a,c,_,f)},SpriteAnim.prototype.sysSetupConstantLoc_=function(t,i){if(-1!=t){var e=Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,s=this.constantAttributeStride_,n=this.constantAttributeInfo_;this.context.enableVertexAttribArray(t),this.context.vertexAttribPointer(t,n[i].size,this.context.FLOAT,!1,s*Float32Array.BYTES_PER_ELEMENT,e+Float32Array.BYTES_PER_ELEMENT*n[i].offset)}},SpriteAnim.prototype.sysDraw=function(t){this.context.enable(this.context.BLEND),this.context.disable(this.context.DEPTH_TEST),this.context.disable(this.context.CULL_FACE),this.context.blendFunc(this.context.ONE,this.context.ONE_MINUS_SRC_ALPHA);for(var i=this.numVertices_,e=0;i>e;++e){var s=this.startPositionData_[0],n=this.startPositionData_[0],o=this.spriteSizeData_[e];s>this.canvas.width+1.1*o?s=-o:-1.1*o>s&&(s=this.canvas.width+o),n>this.canvas.height+1.1*o?n=-o:-1.1*o>n&&(n=this.canvas.height+o),this.positionData_[2*e]=111,this.positionData_[2*e+1]=111}this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.precisePositionView_&&this.precisePositionView_.length==2*i||(this.precisePositionView_=this.positionData_.subarray(0,2*i)),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.precisePositionView_);for(var e=0;e<t.currentTextureUnit_;++e)this.context.activeTexture(this.context.TEXTURE0+e),this.context.bindTexture(this.context.TEXTURE_2D,t.textures_[e]);this.context.useProgram(this.program_),this.context.enableVertexAttribArray(this.centerPositionLoc_),this.context.vertexAttribPointer(this.centerPositionLoc_,2,this.context.FLOAT,!1,0,0),this.sysSetupConstantLoc_(this.rotationLoc_,this.ROTATION_INDEX),this.sysSetupConstantLoc_(this.perSpriteFrameOffsetLoc_,this.PER_SPRITE_FRAME_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteSizeLoc_,this.SPRITE_SIZE_INDEX),this.sysSetupConstantLoc_(this.cornerOffsetLoc_,this.CORNER_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteTextureSizeLoc_,this.SPRITE_TEXTURE_SIZE_INDEX),this.sysSetupConstantLoc_(this.spritesPerRowLoc_,this.SPRITES_PER_ROW_INDEX),this.sysSetupConstantLoc_(this.numFramesLoc_,this.NUM_FRAMES_INDEX),this.sysSetupConstantLoc_(this.textureWeightsLoc_,this.TEXTURE_WEIGHTS_INDEX),0==this.frameOffset_&&this.options.onStart&&this.options.onStart(),this.frameOffset_==t.spriteSheets_[0].params_.frames&&(this.frameOffset_=-1,this.options.onComplete&&this.options.onComplete()),this.context.uniform1f(this.frameOffsetLoc_,this.frameOffset_++),this.context.uniform4f(this.screenDimsLoc_,2/this.screenWidth_,-2/this.screenHeight_,-1,1),this.context.uniform1i(this.texture0Loc_,0),this.context.uniform1i(this.texture1Loc_,1),this.context.uniform1i(this.texture2Loc_,2),this.context.uniform1i(this.texture3Loc_,3),this.context.drawArrays(this.context.TRIANGLES,0,this.numVertices_)},SpriteAnim.prototype.sysAddVertex_=function(t,i,e,s,n,o,h,r,a,c,_,f,u,p){this.numVertices_==this.capacity_&&this.sysResizeCapacity_(2*this.capacity_,!0);var m=this.numVertices_;++this.numVertices_,this.positionData_[2*m]=t,this.positionData_[2*m+1]=i,this.startPositionData_[2*m]=t,this.startPositionData_[2*m+1]=i,this.velocityData_[2*m]=s,this.velocityData_[2*m+1]=n,this.spriteSizeData_[m]=h;var E=this.constantAttributeStride_*m;this.constantData_[E+this.constantAttributeInfo_[this.ROTATION_INDEX].offset]=e,this.constantData_[E+this.constantAttributeInfo_[this.PER_SPRITE_FRAME_OFFSET_INDEX].offset]=o,this.constantData_[E+this.constantAttributeInfo_[this.SPRITE_SIZE_INDEX].offset]=h,this.constantData_[E+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset]=r,this.constantData_[E+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset+1]=a,this.constantData_[E+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset]=c,this.constantData_[E+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset+1]=_,this.constantData_[E+this.constantAttributeInfo_[this.SPRITES_PER_ROW_INDEX].offset]=f,this.constantData_[E+this.constantAttributeInfo_[this.NUM_FRAMES_INDEX].offset]=u,this.constantData_[E+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset]=p[0],this.constantData_[E+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+1]=p[1],this.constantData_[E+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+2]=p[2],this.constantData_[E+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+3]=p[3],this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+E),this.constantData_.subarray(E,E+this.constantAttributeStride_))};