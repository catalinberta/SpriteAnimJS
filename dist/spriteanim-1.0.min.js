/**********************************
* SpriteAnim v0.1 (beta)
* Author: Catalin Berta
* E-mail: catalinberta (at) gmail (dot) com
* Official page and documentation: https://github.com/catalinberta/SpriteAnimJS
* Most of the webgl support & structure is inspired from: http://webglfundamentals.org
**********************************/
function SpriteAnim(t){this.canvas=document.getElementById(t),this.init()}SpriteAnim.prototype.init=function(){this.context=this.webgl_support(this.canvas)?this.create3DContext(this.canvas):this.canvas.getContext("2d")},SpriteAnim.prototype.start=function(t){return this.spriteObj=t,this.onStart(),t.className&&(this.canvas.className=this.canvas.className?this.canvas.className+" "+t.className:t.className),this.width=this.spriteObj.frameWidth,this.height=this.spriteObj.frameHeight,this.totalWidth=this.spriteObj.image.width,this.totalHeight=this.spriteObj.image.height,this.image=this.spriteObj.image,this.canvas.width=this.width,this.canvas.height=this.height,this.horizontalframeIndex=0,this.verticalFrameIndex=0,this.horizontalFrames=this.totalWidth/t.frameWidth||1,this.verticalFrames=this.totalHeight/t.frameHeight||1,this.fps=this.spriteObj.fps,this.timestamp_init=Date.now(),this.interval=1e3/this.fps,this.timestamp_now,this.delta,this.loopSprite=this.spriteObj.loop||!1,this.playSprite=!0,this.webgl_support(this.canvas)?void this.webglStart(t):void this.canvasTicker()},SpriteAnim.prototype.stop=function(){return this.playSprite=!1,this.webgl_support(this.canvas)?void this.webglStop():void this.context.clearRect(0,0,this.totalWidth,this.totalHeight)},SpriteAnim.prototype.canvasUpdate=function(){this.horizontalframeIndex<this.horizontalFrames?(this.horizontalframeIndex+=1,this.draw()):this.verticalFrameIndex<this.verticalFrames?(this.verticalFrameIndex+=1,this.horizontalframeIndex=1,this.draw()):(this.loopSprite?(this.verticalFrameIndex=1,this.horizontalframeIndex=1,this.draw()):this.stop(),this.onComplete())},SpriteAnim.prototype.onStart=function(){this.spriteObj.onStart&&this.spriteObj.onStart()},SpriteAnim.prototype.onComplete=function(){this.spriteObj.onComplete&&this.spriteObj.onComplete()},SpriteAnim.prototype.draw=function(){this.context.clearRect(0,0,this.totalWidth,this.totalHeight),this.context.drawImage(this.image,(this.horizontalframeIndex-1)*this.totalWidth/this.horizontalFrames,(this.verticalFrameIndex-1)*this.totalHeight/this.verticalFrames,this.totalWidth/this.horizontalFrames,this.totalHeight,0,0,this.totalWidth/this.horizontalFrames,this.totalHeight)},SpriteAnim.prototype.canvasTicker=function(){this.playSprite&&(window.requestAnimationFrame(this.canvasTicker.bind(this)),this.timestamp_now=Date.now(),this.delta=this.timestamp_now-this.timestamp_init,this.delta>this.interval&&(this.timestamp_init=this.timestamp_now-this.delta%this.interval,this.canvasUpdate()))},SpriteAnim.prototype.webglStart=function(){function t(){this.spriteSheetCreateSprite(),i()}function i(){e.playSprite&&(window.requestAnimationFrame(i,e.canvas),e.timestamp_now=Date.now(),e.delta=e.timestamp_now-e.timestamp_init,e.delta>e.interval&&(e.context.viewport(0,0,e.width,e.height),e.context.clearColor(0,0,0,0),e.context.clear(e.context.COLOR_BUFFER_BIT|e.context.DEPTH_BUFFER_BIT),e.sysDraw(),e.timestamp_init=e.timestamp_now-e.delta%e.interval))}var e=this;this.onload=null,this.numOutstandingRequests_=0,this.spriteSheets_=[],this.textures_=[],this.currentTextureUnit_=0;var s;this.context&&(this.constantAttributeInfo_=[{size:1,offset:0},{size:1,offset:0},{size:1,offset:0},{size:2,offset:0},{size:2,offset:0},{size:1,offset:0},{size:1,offset:0},{size:4,offset:0}],this.initialize_=function(){if(!this.initialized_){for(var t=this.constantAttributeInfo_,i=0,e=0;e<t.length;++e)t[e].offset=i,i+=t[e].size;this.constantAttributeStride_=i,this.initialized_=!0}},this.constantAttributeStride_=0,this.ROTATION_INDEX=0,this.PER_SPRITE_FRAME_OFFSET_INDEX=1,this.SPRITE_SIZE_INDEX=2,this.CORNER_OFFSET_INDEX=3,this.SPRITE_TEXTURE_SIZE_INDEX=4,this.SPRITES_PER_ROW_INDEX=5,this.NUM_FRAMES_INDEX=6,this.TEXTURE_WEIGHTS_INDEX=7,this.initialize_(),this.sysLoadProgram_(this.spriteObj),this.frameOffset_=0,this.spriteBuffer_=this.context.createBuffer(),this.sysClearAllSprites(),this.offsets_=[[-.5,-.5],[-.5,.5],[.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],this.initialized_=!1,this.screenWidth_=this.totalWidth,this.screenHeight_=this.totalHeight,s=.001*(new Date).getTime(),this.onload=t,this.name_="boom",this.params_={frames:this.horizontalFrames*this.verticalFrames,spritesPerRow:this.horizontalFrames,width:this.width,height:this.height},this.textureUnit_=0,this.perSpriteFrameOffset_=0,this.spriteSheets_.push(this),this.startLoading())},SpriteAnim.prototype.webglStop=function(){this.playSprite=!1,this.sysDraw("clear")},SpriteAnim.prototype.webgl_support=function(){for(var t=["webgl","experimental-webgl"],i=null,e=0;e<t.length;++e){try{i=this.canvas.getContext(t[e])}catch(s){}if(i)break}return i?!0:void 0},SpriteAnim.prototype.create3DContext=function(){function t(){return!1}for(var i=["webgl","experimental-webgl"],e=null,s=0;s<i.length;++s){try{e=this.canvas.getContext(i[s])}catch(o){}if(e)break}return e&&(this.context=e,this.canvas.tdl||(this.canvas.tdl={}),e.tdl={},e.tdl.depthTexture=this.getExtensionWithKnownPrefixes("WEBGL_depth_texture"),this.canvas.onselectstart=t,this.canvas.onmousedown=t),e},SpriteAnim.prototype.getExtensionWithKnownPrefixes=function(t){this.browserPrefixes_=["","MOZ_","OP_","WEBKIT_"];for(var i=0;i<this.browserPrefixes_.length;++i){var e=this.browserPrefixes_[i]+t,s=this.context.getExtension(e);if(s)return s}},SpriteAnim.prototype.startLoading=function(){var t=this.spriteSheets_.length;this.numOutstandingRequests_=t,this.spriteSheetStartLoading()},SpriteAnim.prototype.spriteSheetLoaded_=function(t,i){var e=this.context.createTexture();this.context.bindTexture(this.context.TEXTURE_2D,e),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.context.RGBA,this.context.UNSIGNED_BYTE,i),t.spriteSheetInitialize(this.currentTextureUnit_,i.width,i.height),this.textures_[this.currentTextureUnit_]=e,++this.currentTextureUnit_,0==--this.numOutstandingRequests_&&this.onload&&this.onload()},SpriteAnim.prototype.spriteSheetStartLoading=function(){{var t=this;new Image}this.image_=this.image,t.onload_()},SpriteAnim.prototype.spriteSheetInitialize=function(t,i,e){this.textureUnit_=t,this.textureWidth_=i,this.textureHeight_=e},SpriteAnim.prototype.spriteSheetCreateSprite=function(){var t=this.canvas.width,i=this.canvas.height,e=Math.random()*t,s=Math.random()*i,o=0,n=Math.random()*(t/5)-t/10,h=Math.random()*(i/5)-i/10,a=this.perSpriteFrameOffset_++;this.perSpriteFrameOffset_>=this.params_.frames&&(this.perSpriteFrameOffset_=0);var r=this.params_.width,c=1*this.params_.width/this.textureWidth_,_=1*this.params_.height/this.textureHeight_,p=this.params_.spritesPerRow,f=this.params_.frames,m=[0,0,0,0];m[this.textureUnit_]=1,this.sysAddSprite(e,s,o,n,h,a,r,c,_,p,f,m)},SpriteAnim.prototype.onload_=function(){this.spriteSheetLoaded_(this,this.image_,this.params_)},SpriteAnim.prototype.sysLoadShader=function(t,i){var e=this.context.createShader(i);this.context.shaderSource(e,t),this.context.compileShader(e);this.context.getShaderParameter(e,this.context.COMPILE_STATUS);return e},SpriteAnim.prototype.sysClearAllSprites=function(){this.sysResizeCapacity_(120,!1),this.frameOffset_=0,this.numVertices_=0,this.precisePositionView_=null},SpriteAnim.prototype.sysLoadProgram_=function(){var t="spriteFragmentShader",i=this.sysLoadShader(document.getElementById("spriteVertexShader").text,this.context.VERTEX_SHADER),e=this.sysLoadShader(document.getElementById(t).text,this.context.FRAGMENT_SHADER),s=this.context.createProgram();this.context.attachShader(s,i),this.context.attachShader(s,e),this.context.linkProgram(s);this.context.getProgramParameter(s,this.context.LINK_STATUS);this.context.deleteShader(i),this.context.deleteShader(e),this.program_=s,this.frameOffsetLoc_=this.context.getUniformLocation(s,"u_frameOffset"),this.screenDimsLoc_=this.context.getUniformLocation(s,"u_screenDims"),this.centerPositionLoc_=this.context.getAttribLocation(s,"centerPosition"),this.rotationLoc_=this.context.getAttribLocation(s,"rotation"),this.perSpriteFrameOffsetLoc_=this.context.getAttribLocation(s,"perSpriteFrameOffset"),this.spriteSizeLoc_=this.context.getAttribLocation(s,"spriteSize"),this.cornerOffsetLoc_=this.context.getAttribLocation(s,"cornerOffset"),this.spriteTextureSizeLoc_=this.context.getAttribLocation(s,"spriteTextureSize"),this.spritesPerRowLoc_=this.context.getAttribLocation(s,"spritesPerRow"),this.numFramesLoc_=this.context.getAttribLocation(s,"numFrames"),this.textureWeightsLoc_=this.context.getAttribLocation(s,"textureWeights"),this.texture0Loc_=this.context.getUniformLocation(s,"u_texture0"),this.texture1Loc_=this.context.getUniformLocation(s,"u_texture1"),this.texture2Loc_=this.context.getUniformLocation(s,"u_texture2"),this.texture3Loc_=this.context.getUniformLocation(s,"u_texture3")},SpriteAnim.prototype.sysResizeCapacity_=function(t,i){var e=null,s=null,o=null,n=null,h=null;if(i&&(e=this.positionData_,s=this.constantData_,o=this.startPositionData_,n=this.velocityData_,h=this.spriteSizeData_),this.capacity_=t,this.positionData_=new Float32Array(2*t),this.constantData_=new Float32Array(this.constantAttributeStride_*t),this.startPositionData_=new Array(2*t),this.velocityData_=new Array(2*t),this.spriteSizeData_=new Array(t),this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+this.constantData_.length),this.context.DYNAMIC_DRAW),i){this.positionData_.set(e),this.constantData_.set(s),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.positionData_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,this.constantData_);for(var a=0;a<o.length;++a)this.startPositionData_[a]=o[a];for(var a=0;a<n.length;++a)this.velocityData_[a]=n[a];for(var a=0;a<h.length;++a)this.spriteSizeData_[a]=h[a]}},SpriteAnim.prototype.sysAddSprite=function(t,i,e,s,o,n,h,a,r,c,_,p){for(var f=this.offsets_,m=0;m<f.length;++m)this.sysAddVertex_(t,i,e,s,o,n,h,f[m][0],f[m][1],a,r,c,_,p)},SpriteAnim.prototype.sysSetupConstantLoc_=function(t,i){if(-1!=t){var e=Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,s=this.constantAttributeStride_,o=this.constantAttributeInfo_;this.context.enableVertexAttribArray(t),this.context.vertexAttribPointer(t,o[i].size,this.context.FLOAT,!1,s*Float32Array.BYTES_PER_ELEMENT,e+Float32Array.BYTES_PER_ELEMENT*o[i].offset)}},SpriteAnim.prototype.sysDraw=function(){if(this.frameOffset_==this.spriteSheets_[0].params_.frames){if(!this.loopSprite)return void(this.playSprite=!1);this.frameOffset_=-1,this.spriteObj.onComplete&&this.spriteObj.onComplete()}this.context.enable(this.context.BLEND),this.context.disable(this.context.DEPTH_TEST),this.context.disable(this.context.CULL_FACE),this.context.blendFunc(this.context.ONE,this.context.ONE_MINUS_SRC_ALPHA);for(var t=this.numVertices_,i=0;t>i;++i){var e=this.startPositionData_[0],s=this.startPositionData_[0],o=this.spriteSizeData_[i];e>this.canvas.width+1.1*o?e=-o:-1.1*o>e&&(e=this.canvas.width+o),s>this.canvas.height+1.1*o?s=-o:-1.1*o>s&&(s=this.canvas.height+o),this.positionData_[2*i]=this.width/2,this.positionData_[2*i+1]=this.width/2}this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.precisePositionView_&&this.precisePositionView_.length==2*t||(this.precisePositionView_=this.positionData_.subarray(0,2*t)),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.precisePositionView_);for(var i=0;i<this.currentTextureUnit_;++i)this.context.activeTexture(this.context.TEXTURE0+i),this.context.bindTexture(this.context.TEXTURE_2D,this.textures_[i]);this.context.useProgram(this.program_),this.context.enableVertexAttribArray(this.centerPositionLoc_),this.context.vertexAttribPointer(this.centerPositionLoc_,2,this.context.FLOAT,!1,0,0),this.sysSetupConstantLoc_(this.rotationLoc_,this.ROTATION_INDEX),this.sysSetupConstantLoc_(this.perSpriteFrameOffsetLoc_,this.PER_SPRITE_FRAME_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteSizeLoc_,this.SPRITE_SIZE_INDEX),this.sysSetupConstantLoc_(this.cornerOffsetLoc_,this.CORNER_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteTextureSizeLoc_,this.SPRITE_TEXTURE_SIZE_INDEX),this.sysSetupConstantLoc_(this.spritesPerRowLoc_,this.SPRITES_PER_ROW_INDEX),this.sysSetupConstantLoc_(this.numFramesLoc_,this.NUM_FRAMES_INDEX),this.sysSetupConstantLoc_(this.textureWeightsLoc_,this.TEXTURE_WEIGHTS_INDEX),this.context.uniform1f(this.frameOffsetLoc_,this.frameOffset_++),this.context.uniform4f(this.screenDimsLoc_,2/this.canvas.width,-2/this.canvas.height,-1,1),this.context.uniform1i(this.texture0Loc_,0),this.context.uniform1i(this.texture1Loc_,1),this.context.uniform1i(this.texture2Loc_,2),this.context.uniform1i(this.texture3Loc_,3),this.context.drawArrays(this.context.TRIANGLES,0,this.numVertices_)},SpriteAnim.prototype.sysAddVertex_=function(t,i,e,s,o,n,h,a,r,c,_,p,f,m){this.numVertices_==this.capacity_&&this.sysResizeCapacity_(2*this.capacity_,!0);var E=this.numVertices_;++this.numVertices_,this.positionData_[2*E]=t,this.positionData_[2*E+1]=i,this.startPositionData_[2*E]=t,this.startPositionData_[2*E+1]=i,this.velocityData_[2*E]=s,this.velocityData_[2*E+1]=o,this.spriteSizeData_[E]=h;var x=this.constantAttributeStride_*E;this.constantData_[x+this.constantAttributeInfo_[this.ROTATION_INDEX].offset]=e,this.constantData_[x+this.constantAttributeInfo_[this.PER_SPRITE_FRAME_OFFSET_INDEX].offset]=n,this.constantData_[x+this.constantAttributeInfo_[this.SPRITE_SIZE_INDEX].offset]=h,this.constantData_[x+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset]=a,this.constantData_[x+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset+1]=r,this.constantData_[x+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset]=c,this.constantData_[x+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset+1]=_,this.constantData_[x+this.constantAttributeInfo_[this.SPRITES_PER_ROW_INDEX].offset]=p,this.constantData_[x+this.constantAttributeInfo_[this.NUM_FRAMES_INDEX].offset]=f,this.constantData_[x+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset]=m[0],this.constantData_[x+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+1]=m[1],this.constantData_[x+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+2]=m[2],this.constantData_[x+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+3]=m[3],this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+x),this.constantData_.subarray(x,x+this.constantAttributeStride_))};