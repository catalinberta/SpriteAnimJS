/**********************************
* SpriteAnim v0.1.0 (beta)
* Author: Catalin Berta
* E-mail: catalinberta (at) gmail (dot) com
* Official page and documentation: https://github.com/catalinberta/SpriteAnimJS
* Most of the webgl support & structure is inspired from: http://webglfundamentals.org
**********************************/
!function(t){"use strict";var i=function(t){this.canvas=document.getElementById(t),this.init()};i.prototype.init=function(){this.context=this.webgl_support(this.canvas)?this.create3DContext(this.canvas):this.canvas.getContext("2d")},i.prototype.start=function(t){return this.spriteObj=t,this.onStart(),t.className&&(this.canvas.className=this.canvas.className?this.canvas.className+" "+t.className:t.className),this.width=this.spriteObj.frameWidth,this.height=this.spriteObj.frameHeight,this.totalWidth=this.spriteObj.image.width,this.totalHeight=this.spriteObj.image.height,this.image=this.spriteObj.image,this.canvas.width=this.width,this.canvas.height=this.height,this.horizontalframeIndex=0,this.verticalFrameIndex=0,this.horizontalFrames=this.totalWidth/t.frameWidth||1,this.verticalFrames=this.totalHeight/t.frameHeight||1,this.fps=this.spriteObj.fps||30,this.timestamp_init=Date.now(),this.interval=1e3/this.fps,this.timestamp_now,this.delta,this.loopSprite=this.spriteObj.loop||!1,this.playSprite=!0,this.webgl_support(this.canvas)?void this.webglStart(t):void this.canvasTicker()},i.prototype.stop=function(){return this.playSprite=!1,this.webgl_support(this.canvas)?void this.webglStop():void this.context.clearRect(0,0,this.totalWidth,this.totalHeight)},i.prototype.canvasUpdate=function(){this.horizontalframeIndex<this.horizontalFrames?(this.horizontalframeIndex+=1,this.draw()):this.verticalFrameIndex<this.verticalFrames?(this.verticalFrameIndex+=1,this.horizontalframeIndex=1,this.draw()):(this.loopSprite?(this.verticalFrameIndex=1,this.horizontalframeIndex=1,this.draw()):this.stop(),this.onComplete())},i.prototype.onStart=function(){this.spriteObj.onStart&&this.spriteObj.onStart()},i.prototype.onComplete=function(){this.spriteObj.onComplete&&this.spriteObj.onComplete()},i.prototype.draw=function(){this.context.clearRect(0,0,this.totalWidth,this.totalHeight),this.context.drawImage(this.image,(this.horizontalframeIndex-1)*this.totalWidth/this.horizontalFrames,(this.verticalFrameIndex-1)*this.totalHeight/this.verticalFrames,this.totalWidth/this.horizontalFrames,this.totalHeight,0,0,this.totalWidth/this.horizontalFrames,this.totalHeight)},i.prototype.canvasTicker=function(){this.playSprite&&(t.requestAnimationFrame(this.canvasTicker.bind(this)),this.timestamp_now=Date.now(),this.delta=this.timestamp_now-this.timestamp_init,this.delta>this.interval&&(this.timestamp_init=this.timestamp_now-this.delta%this.interval,this.canvasUpdate()))},i.prototype.webglStart=function(){function t(){this.spriteSheetCreateSprite(),this.webglTicker()}this.onload=null,this.numOutstandingRequests_=0,this.spriteSheets_=[],this.textures_=[],this.currentTextureUnit_=0,this.constantAttributeInfo_=[{size:1,offset:0},{size:1,offset:0},{size:1,offset:0},{size:2,offset:0},{size:2,offset:0},{size:1,offset:0},{size:1,offset:0},{size:4,offset:0}],this.initialize_=function(){if(!this.initialized_){for(var t=this.constantAttributeInfo_,i=0,s=0;s<t.length;++s)t[s].offset=i,i+=t[s].size;this.constantAttributeStride_=i,this.initialized_=!0}},this.constantAttributeStride_=0,this.ROTATION_INDEX=0,this.PER_SPRITE_FRAME_OFFSET_INDEX=1,this.SPRITE_SIZE_INDEX=2,this.CORNER_OFFSET_INDEX=3,this.SPRITE_TEXTURE_SIZE_INDEX=4,this.SPRITES_PER_ROW_INDEX=5,this.NUM_FRAMES_INDEX=6,this.TEXTURE_WEIGHTS_INDEX=7,this.initialize_(),this.sysLoadProgram_(this.spriteObj),this.frameOffset_=0,this.spriteBuffer_=this.context.createBuffer(),this.sysClearAllSprites(),this.offsets_=[[-.5,-.5],[-.5,.5],[.5,-.5],[.5,-.5],[-.5,.5],[.5,.5]],this.initialized_=!1,this.screenWidth_=this.totalWidth,this.screenHeight_=this.totalHeight,this.onload=t,this.name_="boom",this.params_={frames:this.horizontalFrames*this.verticalFrames,spritesPerRow:this.horizontalFrames,width:this.width,height:this.height},this.textureUnit_=0,this.perSpriteFrameOffset_=0,this.spriteSheets_.push(this),this.startLoading()},i.prototype.webglStop=function(){this.playSprite=!1,this.sysDraw("clear")},i.prototype.webgl_support=function(){for(var t=["webgl","experimental-webgl"],i=null,s=0;s<t.length;++s){try{i=this.canvas.getContext(t[s])}catch(e){}if(i)break}return i?!0:void 0},i.prototype.create3DContext=function(){for(var t=["webgl","experimental-webgl"],i=null,s=0;s<t.length;++s){try{i=this.canvas.getContext(t[s])}catch(e){}if(i)break}return i&&(this.context=i,this.canvas.tdl||(this.canvas.tdl={}),i.tdl={},i.tdl.depthTexture=this.getExtensionWithKnownPrefixes("WEBGL_depth_texture")),i},i.prototype.getExtensionWithKnownPrefixes=function(t){this.browserPrefixes_=["","MOZ_","OP_","WEBKIT_"];for(var i=0;i<this.browserPrefixes_.length;++i){var s=this.browserPrefixes_[i]+t,e=this.context.getExtension(s);if(e)return e}},i.prototype.startLoading=function(){var t=this.spriteSheets_.length;this.numOutstandingRequests_=t,this.spriteSheetStartLoading()},i.prototype.spriteSheetLoaded_=function(t,i){var s=this.context.createTexture();this.context.bindTexture(this.context.TEXTURE_2D,s),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.LINEAR),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE),this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE),this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.context.RGBA,this.context.UNSIGNED_BYTE,i),t.spriteSheetInitialize(this.currentTextureUnit_,i.width,i.height),this.textures_[this.currentTextureUnit_]=s,++this.currentTextureUnit_,0==--this.numOutstandingRequests_&&this.onload&&this.onload()},i.prototype.spriteSheetStartLoading=function(){{var t=this;new Image}this.image_=this.image,t.onload_()},i.prototype.spriteSheetInitialize=function(t,i,s){this.textureUnit_=t,this.textureWidth_=i,this.textureHeight_=s},i.prototype.spriteSheetCreateSprite=function(){var t=(this.canvas.width,this.canvas.height,0),i=0,s=0,e=0,h=0,o=this.perSpriteFrameOffset_++;this.perSpriteFrameOffset_>=this.params_.frames&&(this.perSpriteFrameOffset_=0);var a=this.params_.width,n=1*this.params_.width/this.textureWidth_,r=1*this.params_.height/this.textureHeight_,c=this.params_.spritesPerRow,_=this.params_.frames,p=[0,0,0,0];p[this.textureUnit_]=1,this.sysAddSprite(t,i,s,e,h,o,a,n,r,c,_,p)},i.prototype.onload_=function(){this.spriteSheetLoaded_(this,this.image_,this.params_)},i.prototype.sysLoadShader=function(t,i){var s=this.context.createShader(i);this.context.shaderSource(s,t),this.context.compileShader(s);this.context.getShaderParameter(s,this.context.COMPILE_STATUS);return s},i.prototype.sysClearAllSprites=function(){this.sysResizeCapacity_(120,!1),this.frameOffset_=0,this.numVertices_=0,this.precisePositionView_=null},i.prototype.sysLoadProgram_=function(){var t="spriteFragmentShader",i=this.sysLoadShader(document.getElementById("spriteVertexShader").text,this.context.VERTEX_SHADER),s=this.sysLoadShader(document.getElementById(t).text,this.context.FRAGMENT_SHADER),e=this.context.createProgram();this.context.attachShader(e,i),this.context.attachShader(e,s),this.context.linkProgram(e);this.context.getProgramParameter(e,this.context.LINK_STATUS);this.context.deleteShader(i),this.context.deleteShader(s),this.program_=e,this.frameOffsetLoc_=this.context.getUniformLocation(e,"u_frameOffset"),this.screenDimsLoc_=this.context.getUniformLocation(e,"u_screenDims"),this.centerPositionLoc_=this.context.getAttribLocation(e,"centerPosition"),this.rotationLoc_=this.context.getAttribLocation(e,"rotation"),this.perSpriteFrameOffsetLoc_=this.context.getAttribLocation(e,"perSpriteFrameOffset"),this.spriteSizeLoc_=this.context.getAttribLocation(e,"spriteSize"),this.cornerOffsetLoc_=this.context.getAttribLocation(e,"cornerOffset"),this.spriteTextureSizeLoc_=this.context.getAttribLocation(e,"spriteTextureSize"),this.spritesPerRowLoc_=this.context.getAttribLocation(e,"spritesPerRow"),this.numFramesLoc_=this.context.getAttribLocation(e,"numFrames"),this.textureWeightsLoc_=this.context.getAttribLocation(e,"textureWeights"),this.texture0Loc_=this.context.getUniformLocation(e,"u_texture0"),this.texture1Loc_=this.context.getUniformLocation(e,"u_texture1"),this.texture2Loc_=this.context.getUniformLocation(e,"u_texture2"),this.texture3Loc_=this.context.getUniformLocation(e,"u_texture3")},i.prototype.sysResizeCapacity_=function(t,i){var s=null,e=null,h=null,o=null,a=null;if(i&&(s=this.positionData_,e=this.constantData_,h=this.startPositionData_,o=this.velocityData_,a=this.spriteSizeData_),this.capacity_=t,this.positionData_=new Float32Array(2*t),this.constantData_=new Float32Array(this.constantAttributeStride_*t),this.startPositionData_=new Array(2*t),this.velocityData_=new Array(2*t),this.spriteSizeData_=new Array(t),this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+this.constantData_.length),this.context.DYNAMIC_DRAW),i){this.positionData_.set(s),this.constantData_.set(e),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.positionData_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,this.constantData_);for(var n=0;n<h.length;++n)this.startPositionData_[n]=h[n];for(var n=0;n<o.length;++n)this.velocityData_[n]=o[n];for(var n=0;n<a.length;++n)this.spriteSizeData_[n]=a[n]}},i.prototype.sysAddSprite=function(t,i,s,e,h,o,a,n,r,c,_,p){for(var f=this.offsets_,E=0;E<f.length;++E)this.sysAddVertex_(t,i,s,e,h,o,a,f[E][0],f[E][1],n,r,c,_,p)},i.prototype.sysSetupConstantLoc_=function(t,i){if(-1!=t){var s=Float32Array.BYTES_PER_ELEMENT*this.positionData_.length,e=this.constantAttributeStride_,h=this.constantAttributeInfo_;this.context.enableVertexAttribArray(t),this.context.vertexAttribPointer(t,h[i].size,this.context.FLOAT,!1,e*Float32Array.BYTES_PER_ELEMENT,s+Float32Array.BYTES_PER_ELEMENT*h[i].offset)}},i.prototype.sysDraw=function(){if(this.frameOffset_==this.spriteSheets_[0].params_.frames){if(!this.loopSprite)return void(this.playSprite=!1);this.frameOffset_=-1,this.spriteObj.onComplete&&this.spriteObj.onComplete()}this.context.enable(this.context.BLEND),this.context.disable(this.context.DEPTH_TEST),this.context.disable(this.context.CULL_FACE),this.context.blendFunc(this.context.ONE,this.context.ONE_MINUS_SRC_ALPHA);for(var t=this.numVertices_,i=0;t>i;++i){var s=this.startPositionData_[0],e=this.startPositionData_[0],h=this.spriteSizeData_[i];s>this.canvas.width+1.1*h?s=-h:-1.1*h>s&&(s=this.canvas.width+h),e>this.canvas.height+1.1*h?e=-h:-1.1*h>e&&(e=this.canvas.height+h),this.positionData_[2*i]=this.width/2,this.positionData_[2*i+1]=this.width/2}this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.precisePositionView_&&this.precisePositionView_.length==2*t||(this.precisePositionView_=this.positionData_.subarray(0,2*t)),this.context.bufferSubData(this.context.ARRAY_BUFFER,0,this.precisePositionView_);for(var i=0;i<this.currentTextureUnit_;++i)this.context.activeTexture(this.context.TEXTURE0+i),this.context.bindTexture(this.context.TEXTURE_2D,this.textures_[i]);this.context.useProgram(this.program_),this.context.enableVertexAttribArray(this.centerPositionLoc_),this.context.vertexAttribPointer(this.centerPositionLoc_,2,this.context.FLOAT,!1,0,0),this.sysSetupConstantLoc_(this.rotationLoc_,this.ROTATION_INDEX),this.sysSetupConstantLoc_(this.perSpriteFrameOffsetLoc_,this.PER_SPRITE_FRAME_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteSizeLoc_,this.SPRITE_SIZE_INDEX),this.sysSetupConstantLoc_(this.cornerOffsetLoc_,this.CORNER_OFFSET_INDEX),this.sysSetupConstantLoc_(this.spriteTextureSizeLoc_,this.SPRITE_TEXTURE_SIZE_INDEX),this.sysSetupConstantLoc_(this.spritesPerRowLoc_,this.SPRITES_PER_ROW_INDEX),this.sysSetupConstantLoc_(this.numFramesLoc_,this.NUM_FRAMES_INDEX),this.sysSetupConstantLoc_(this.textureWeightsLoc_,this.TEXTURE_WEIGHTS_INDEX),this.context.uniform1f(this.frameOffsetLoc_,this.frameOffset_++),this.context.uniform4f(this.screenDimsLoc_,2/this.canvas.width,-2/this.canvas.height,-1,1),this.context.uniform1i(this.texture0Loc_,0),this.context.uniform1i(this.texture1Loc_,1),this.context.uniform1i(this.texture2Loc_,2),this.context.uniform1i(this.texture3Loc_,3),this.context.drawArrays(this.context.TRIANGLES,0,this.numVertices_)},i.prototype.sysAddVertex_=function(t,i,s,e,h,o,a,n,r,c,_,p,f,E){this.numVertices_==this.capacity_&&this.sysResizeCapacity_(2*this.capacity_,!0);var x=this.numVertices_;++this.numVertices_,this.positionData_[2*x]=t,this.positionData_[2*x+1]=i,this.startPositionData_[2*x]=t,this.startPositionData_[2*x+1]=i,this.velocityData_[2*x]=e,this.velocityData_[2*x+1]=h,this.spriteSizeData_[x]=a;var u=this.constantAttributeStride_*x;this.constantData_[u+this.constantAttributeInfo_[this.ROTATION_INDEX].offset]=s,this.constantData_[u+this.constantAttributeInfo_[this.PER_SPRITE_FRAME_OFFSET_INDEX].offset]=o,this.constantData_[u+this.constantAttributeInfo_[this.SPRITE_SIZE_INDEX].offset]=a,this.constantData_[u+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset]=n,this.constantData_[u+this.constantAttributeInfo_[this.CORNER_OFFSET_INDEX].offset+1]=r,this.constantData_[u+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset]=c,this.constantData_[u+this.constantAttributeInfo_[this.SPRITE_TEXTURE_SIZE_INDEX].offset+1]=_,this.constantData_[u+this.constantAttributeInfo_[this.SPRITES_PER_ROW_INDEX].offset]=p,this.constantData_[u+this.constantAttributeInfo_[this.NUM_FRAMES_INDEX].offset]=f,this.constantData_[u+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset]=E[0],this.constantData_[u+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+1]=E[1],this.constantData_[u+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+2]=E[2],this.constantData_[u+this.constantAttributeInfo_[this.TEXTURE_WEIGHTS_INDEX].offset+3]=E[3],this.context.bindBuffer(this.context.ARRAY_BUFFER,this.spriteBuffer_),this.context.bufferSubData(this.context.ARRAY_BUFFER,Float32Array.BYTES_PER_ELEMENT*(this.positionData_.length+u),this.constantData_.subarray(u,u+this.constantAttributeStride_))},i.prototype.webglTicker=function(){this.playSprite&&(t.requestAnimationFrame(this.webglTicker.bind(this)),this.timestamp_now=Date.now(),this.delta=this.timestamp_now-this.timestamp_init,this.delta>this.interval&&(this.context.viewport(0,0,this.width,this.height),this.context.clearColor(0,0,0,0),this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT),this.sysDraw(),this.timestamp_init=this.timestamp_now-this.delta%this.interval))},t.SpriteAnim=i}(window);